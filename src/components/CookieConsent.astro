---
import type { Locale } from '../i18n/locales';
import { getLocaleFromUrl, useTranslations } from '../i18n/utils';

const locale = (Astro.currentLocale ?? getLocaleFromUrl(Astro.url.pathname)) as Locale;
const t = useTranslations(locale);
---

<div id="cookie-banner" class="cookie-banner" role="dialog" aria-label={t('cookie.settings.title')}>
	<div class="cookie-inner">
		<p class="cookie-text">{t('cookie.text')}</p>
		<div class="cookie-actions">
			<button id="cookie-reject" class="cookie-btn cookie-btn--secondary" type="button">
				{t('cookie.reject')}
			</button>
			<button id="cookie-settings-toggle" class="cookie-btn cookie-btn--secondary" type="button">
				{t('cookie.settings')}
			</button>
			<button id="cookie-accept" class="cookie-btn cookie-btn--primary" type="button">
				{t('cookie.accept')}
			</button>
		</div>
	</div>

	<div id="cookie-settings-panel" class="cookie-settings" hidden>
		<h3 class="cookie-settings__title">{t('cookie.settings.title')}</h3>
		<div class="cookie-settings__option">
			<label class="cookie-toggle">
				<input type="checkbox" id="cookie-opt-analytics" />
				<span class="cookie-toggle__slider"></span>
				<span class="cookie-toggle__label">{t('cookie.analytics')}</span>
			</label>
			<p class="cookie-settings__desc">{t('cookie.analytics.desc')}</p>
		</div>
		<div class="cookie-settings__option">
			<label class="cookie-toggle">
				<input type="checkbox" id="cookie-opt-ads" />
				<span class="cookie-toggle__slider"></span>
				<span class="cookie-toggle__label">{t('cookie.ads')}</span>
			</label>
			<p class="cookie-settings__desc">{t('cookie.ads.desc')}</p>
		</div>
		<button id="cookie-save" class="cookie-btn cookie-btn--primary" type="button">
			{t('cookie.save')}
		</button>
	</div>
</div>

<script is:inline>
(function() {
	var STORAGE_KEY = 'vf-cookie-consent';
	var banner = document.getElementById('cookie-banner');
	var settingsPanel = document.getElementById('cookie-settings-panel');
	var btnAccept = document.getElementById('cookie-accept');
	var btnReject = document.getElementById('cookie-reject');
	var btnSettings = document.getElementById('cookie-settings-toggle');
	var btnSave = document.getElementById('cookie-save');
	var optAnalytics = document.getElementById('cookie-opt-analytics');
	var optAds = document.getElementById('cookie-opt-ads');

	// If user already made a choice, hide banner
	if (localStorage.getItem(STORAGE_KEY)) {
		banner.style.display = 'none';
		console.log('[Consent] Banner hidden â€” choice already saved');
		return;
	}

	// Show the banner
	banner.classList.add('cookie-banner--visible');
	console.log('[Consent] Banner displayed');

	function saveAndHide(prefs) {
		localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));

		// Update Google consent
		if (typeof gtag === 'function') {
			gtag('consent', 'update', prefs);
			console.log('[Consent] gtag updated:', prefs);
		}

		banner.classList.remove('cookie-banner--visible');
		setTimeout(function() { banner.style.display = 'none'; }, 300);
		console.log('[Consent] Choice saved:', prefs);
	}

	btnAccept.addEventListener('click', function() {
		saveAndHide({
			analytics_storage: 'granted',
			ad_storage: 'granted',
			ad_user_data: 'granted',
			ad_personalization: 'granted'
		});
	});

	btnReject.addEventListener('click', function() {
		saveAndHide({
			analytics_storage: 'denied',
			ad_storage: 'denied',
			ad_user_data: 'denied',
			ad_personalization: 'denied'
		});
	});

	btnSettings.addEventListener('click', function() {
		var isHidden = settingsPanel.hidden;
		settingsPanel.hidden = !isHidden;
		console.log('[Consent] Settings panel', isHidden ? 'opened' : 'closed');
	});

	btnSave.addEventListener('click', function() {
		var analyticsGranted = optAnalytics.checked ? 'granted' : 'denied';
		var adsGranted = optAds.checked ? 'granted' : 'denied';
		saveAndHide({
			analytics_storage: analyticsGranted,
			ad_storage: adsGranted,
			ad_user_data: adsGranted,
			ad_personalization: adsGranted
		});
	});
})();
</script>

<style>
	.cookie-banner {
		--cookie-bg: #1a1a2e;
		--cookie-text: #e0e0e0;
		--cookie-primary: #1a5fb4;
		--cookie-primary-hover: #1550a0;
		--cookie-secondary: rgba(255, 255, 255, 0.12);
		--cookie-secondary-hover: rgba(255, 255, 255, 0.2);
		--cookie-border: rgba(255, 255, 255, 0.1);
		--cookie-radius: 8px;

		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		z-index: 9999;
		background: var(--cookie-bg);
		border-top: 1px solid var(--cookie-border);
		box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
		color: var(--cookie-text);
		font-size: 0.9rem;
		transform: translateY(100%);
		opacity: 0;
		transition: transform 0.3s ease, opacity 0.3s ease;
		display: none;
	}

	.cookie-banner--visible {
		display: block;
		transform: translateY(0);
		opacity: 1;
	}

	.cookie-inner {
		max-width: 1200px;
		margin: 0 auto;
		padding: 1.25rem 1.5rem;
		display: flex;
		align-items: center;
		gap: 1.5rem;
		flex-wrap: wrap;
	}

	.cookie-text {
		margin: 0;
		flex: 1 1 300px;
		line-height: 1.5;
	}

	.cookie-actions {
		display: flex;
		gap: 0.5rem;
		flex-shrink: 0;
		flex-wrap: wrap;
	}

	.cookie-btn {
		padding: 0.6rem 1.25rem;
		border: none;
		border-radius: var(--cookie-radius);
		font-size: 0.85rem;
		font-weight: 600;
		cursor: pointer;
		transition: background 0.2s ease, transform 0.1s ease;
		white-space: nowrap;
	}

	.cookie-btn:active {
		transform: scale(0.97);
	}

	.cookie-btn--primary {
		background: var(--cookie-primary);
		color: #fff;
	}

	.cookie-btn--primary:hover {
		background: var(--cookie-primary-hover);
	}

	.cookie-btn--secondary {
		background: var(--cookie-secondary);
		color: var(--cookie-text);
	}

	.cookie-btn--secondary:hover {
		background: var(--cookie-secondary-hover);
	}

	/* Settings panel */
	.cookie-settings {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 1.5rem 1.25rem;
		border-top: 1px solid var(--cookie-border);
	}

	.cookie-settings__title {
		font-size: 1rem;
		margin: 1rem 0 0.75rem;
		color: #fff;
	}

	.cookie-settings__option {
		margin-bottom: 0.75rem;
	}

	.cookie-settings__desc {
		margin: 0.25rem 0 0 3.25rem;
		font-size: 0.8rem;
		opacity: 0.7;
	}

	/* Toggle switch */
	.cookie-toggle {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		cursor: pointer;
	}

	.cookie-toggle input {
		position: absolute;
		opacity: 0;
		width: 0;
		height: 0;
	}

	.cookie-toggle__slider {
		position: relative;
		width: 40px;
		height: 22px;
		background: rgba(255, 255, 255, 0.2);
		border-radius: 11px;
		transition: background 0.2s ease;
		flex-shrink: 0;
	}

	.cookie-toggle__slider::after {
		content: '';
		position: absolute;
		top: 3px;
		left: 3px;
		width: 16px;
		height: 16px;
		background: #fff;
		border-radius: 50%;
		transition: transform 0.2s ease;
	}

	.cookie-toggle input:checked + .cookie-toggle__slider {
		background: var(--cookie-primary);
	}

	.cookie-toggle input:checked + .cookie-toggle__slider::after {
		transform: translateX(18px);
	}

	.cookie-toggle__label {
		font-size: 0.9rem;
		font-weight: 500;
	}

	@media (max-width: 600px) {
		.cookie-inner {
			flex-direction: column;
			align-items: stretch;
			padding: 1rem;
			gap: 1rem;
		}

		.cookie-actions {
			flex-direction: column;
		}

		.cookie-btn {
			width: 100%;
			text-align: center;
			min-height: 44px;
		}

		.cookie-settings {
			padding: 0 1rem 1rem;
		}

		.cookie-settings__desc {
			margin-left: 3.25rem;
		}
	}
</style>
